# SPDX-FileCopyrightText: 2023, 2024 Nikita Chernyi
# SPDX-FileCopyrightText: 2023-2025 Slavi Pantaleev
# SPDX-FileCopyrightText: 2024 Sergio Durigan Junior
# SPDX-FileCopyrightText: 2025 MASH project contributors
# SPDX-FileCopyrightText: 2025, 2026 Suguru Hirahara
#
# SPDX-License-Identifier: AGPL-3.0-or-later

---
# Project source code URL: https://github.com/charmbracelet/soft-serve

soft_serve_enabled: true

soft_serve_identifier: soft-serve
soft_serve_base_path: "/{{ soft_serve_identifier }}"
soft_serve_data_path: "{{ soft_serve_base_path }}/data"

# renovate: datasource=docker depName=charmcli/soft-serve versioning=semver
soft_serve_version: v0.11.3

soft_serve_uid: ""
soft_serve_gid: ""

# The hostname at which Soft Serve is served.
soft_serve_hostname: ""

soft_serve_container_image: "{{ soft_serve_container_image_registry_prefix }}charmcli/soft-serve:{{ soft_serve_container_image_tag }}"
soft_serve_container_image_tag: "{{ soft_serve_version }}"
soft_serve_container_image_registry_prefix: "{{ soft_serve_container_image_registry_prefix_upstream }}"
soft_serve_container_image_registry_prefix_upstream: "{{ soft_serve_container_image_registry_prefix_upstream_default }}"
soft_serve_container_image_registry_prefix_upstream_default: docker.io/
soft_serve_container_image_force_pull: "{{ soft_serve_container_image.endswith(':latest') }}"

# Controls whether the container exposes a port (the same in the container)
# that can be used to access soft-serve from outside the container
soft_serve_container_bind_port: ""

# The base container network. It will be auto-created by this role if it doesn't exist already.
soft_serve_container_network: "{{ soft_serve_identifier }}"

# Control if the container network is deleted on uninstalling.
soft_serve_container_network_deletion_enabled: true

# A list of additional container networks that the container would be connected to.
# The role does not create these networks, so make sure they already exist.
soft_serve_container_additional_networks: "{{ soft_serve_container_additional_networks_auto + soft_serve_container_additional_networks_custom }}"
soft_serve_container_additional_networks_auto: []
soft_serve_container_additional_networks_custom: []

# A list of extra arguments to pass to the container (`docker create` command)
soft_serve_container_extra_arguments: "{{ soft_serve_container_extra_arguments_auto + soft_serve_container_extra_arguments_custom }}"
soft_serve_container_extra_arguments_auto: []
soft_serve_container_extra_arguments_custom: []

# List of systemd services that the soft_serve systemd service depends on
soft_serve_systemd_required_services_list: "{{ soft_serve_systemd_required_services_list_default + soft_serve_systemd_required_services_list_auto + soft_serve_systemd_required_services_list_custom }}"
soft_serve_systemd_required_services_list_default: "{{ [devture_systemd_docker_base_docker_service_name] if devture_systemd_docker_base_docker_service_name else [] }}"
soft_serve_systemd_required_services_list_auto: []
soft_serve_systemd_required_services_list_custom: []

# List of systemd services that the soft_serve systemd service wants
soft_serve_systemd_wanted_services_list: "{{ soft_serve_systemd_wanted_services_list_default + soft_serve_systemd_wanted_services_list_auto + soft_serve_systemd_wanted_services_list_custom }}"
soft_serve_systemd_wanted_services_list_default: []
soft_serve_systemd_wanted_services_list_auto: []
soft_serve_systemd_wanted_services_list_custom: []

# Controls how long to wait for the container to stop gracefully before killing it.
soft_serve_container_stop_grace_time_seconds: "{{ devture_systemd_docker_base_container_stop_grace_time_seconds }}"

# Controls how long the pre-start cleanup should wait for stale container-name release
# before failing startup explicitly.
soft_serve_container_cleanup_timeout_seconds: "{{ devture_systemd_docker_base_container_cleanup_timeout_seconds }}"

# Controls the delay between pre-start cleanup retries.
soft_serve_container_cleanup_retry_delay_seconds: "{{ devture_systemd_docker_base_container_cleanup_retry_delay_seconds }}"

# Shell command used in the systemd pre-start phase to deterministically remove a stale
# container and wait until Docker releases its name.
soft_serve_container_cleanup_command: |
  i=0;
  while [ "$i" -lt {{ soft_serve_container_cleanup_timeout_seconds }} ]; do
  {{ devture_systemd_docker_base_host_command_docker }} stop -t {{ soft_serve_container_stop_grace_time_seconds }} {{ soft_serve_identifier }} >/dev/null 2>&1 || true;
  {{ devture_systemd_docker_base_host_command_docker }} rm -f {{ soft_serve_identifier }} >/dev/null 2>&1 || true;
  if {{ devture_systemd_docker_base_host_command_docker }} container inspect {{ soft_serve_identifier }} >/dev/null 2>&1; then
  i=$((i + 1));
  sleep {{ soft_serve_container_cleanup_retry_delay_seconds }};
  continue;
  fi;
  if {{ devture_systemd_docker_base_host_command_docker }} info >/dev/null 2>&1; then
  exit 0;
  fi;
  echo "Failed to query Docker daemon while cleaning up {{ soft_serve_identifier }}" >&2;
  exit 1;
  done;
  echo "Failed to remove stale container {{ soft_serve_identifier }} after {{ soft_serve_container_cleanup_timeout_seconds }} attempts" >&2;
  exit 1

soft_serve_initial_admin_key: ""

# Specify the timezone
soft_serve_environment_variables_tz: UTC

# Additional environment variables.
soft_serve_environment_variables_additional_variables: ""
